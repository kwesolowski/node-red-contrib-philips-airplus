<script type="text/javascript">
    RED.nodes.registerType('airplus-account', {
        category: 'config',
        defaults: {
            name: { value: '' },
            verboseLogging: { value: false }
        },
        credentials: {
            userId: { type: 'text' },
            refreshToken: { type: 'password' },
            expiresAt: { type: 'text' }
        },
        label: function() {
            return this.name || 'Philips Air+';
        },
        oneditprepare: function() {
            var node = this;
            var autoLoadAttempted = false;

            function updateAuthStatus() {
                var hasCredentials = node.credentials && node.credentials.hasOwnProperty('refreshToken');
                var expiresAt = node.credentials ? node.credentials.expiresAt : null;

                if (hasCredentials && expiresAt) {
                    var expDate = new Date(parseInt(expiresAt, 10) * 1000);
                    var now = new Date();
                    if (expDate > now) {
                        var userId = node.credentials.userId || 'unknown';
                        var userIdShort = userId.length > 8 ? userId.substring(0, 8) + '...' : userId;
                        $('#auth-status').text('Authenticated (User: ' + userIdShort + ')')
                            .removeClass('auth-error').addClass('auth-success');
                        $('#auth-section-setup').hide();
                        $('#auth-section-authenticated').show();
                    } else {
                        $('#auth-status').text('Token expired')
                            .removeClass('auth-success').addClass('auth-error');
                        showSetupSection();
                    }
                } else {
                    $('#auth-status').text('Not authenticated')
                        .removeClass('auth-success').addClass('auth-error');
                    showSetupSection();
                }
            }

            function showSetupSection() {
                $('#auth-section-authenticated').hide();
                $('#auth-section-setup').show();
                checkCliCredentials();
            }

            function checkCliCredentials() {
                $.ajax({
                    url: 'philips-airplus/cli-credentials',
                    type: 'GET',
                    success: function(data) {
                        if (data.exists) {
                            $('#cli-status').html(
                                '<span class="auth-success">CLI credentials found</span><br>' +
                                '<small>User: ' + data.userId + '</small>'
                            );
                            $('#load-cli-btn').show();
                            $('#cli-instructions').hide();

                            // Auto-load if Node-RED credentials are missing (only once)
                            var hasNodeRedCreds = node.credentials && node.credentials.refreshToken;
                            console.log('[airplus-account] Auto-load check:', {
                                hasCredentials: !!node.credentials,
                                hasRefreshToken: !!hasNodeRedCreds,
                                autoLoadAttempted: autoLoadAttempted,
                                willAutoLoad: !hasNodeRedCreds && !autoLoadAttempted
                            });
                            if (!hasNodeRedCreds && !autoLoadAttempted) {
                                autoLoadAttempted = true;
                                console.log('[airplus-account] Auto-loading CLI credentials...');
                                $('#load-cli-btn').click();
                            }
                        } else {
                            $('#cli-status').html('<span class="auth-error">No CLI credentials</span>');
                            $('#load-cli-btn').hide();
                            $('#cli-instructions').show();
                        }
                    },
                    error: function() {
                        $('#cli-status').html('<span class="auth-error">Could not check CLI status</span>');
                        $('#cli-instructions').show();
                    }
                });
            }

            // Load credentials from CLI file
            $('#load-cli-btn').on('click', function() {
                $(this).prop('disabled', true).text('Loading...');

                $.ajax({
                    url: 'philips-airplus/load-cli-credentials',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ node: node.id }),
                    success: function(data) {
                        if (data.success) {
                            RED.notify('Credentials loaded from CLI', 'success');
                            node.credentials = node.credentials || {};
                            node.credentials.userId = data.userId;
                            node.credentials.refreshToken = '***loaded***'; // Placeholder (real token stored server-side)
                            node.credentials.expiresAt = String(data.expiresAt);
                            updateAuthStatus();
                        }
                        $('#load-cli-btn').prop('disabled', false).text('Load from CLI');
                    },
                    error: function(xhr) {
                        var error = xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error';
                        RED.notify('Failed to load: ' + error, 'error');
                        $('#load-cli-btn').prop('disabled', false).text('Load from CLI');
                    }
                });
            });

            // Refresh CLI status
            $('#refresh-cli-btn').on('click', function() {
                checkCliCredentials();
            });

            // Toggle import JSON section
            $('#show-import-json').on('click', function() {
                $('#import-json-section').toggle();
            });

            // File upload import handlers
            function importCredentialsFile(file) {
                if (!file) {
                    RED.notify('No file selected', 'error');
                    return;
                }

                if (!file.name.endsWith('.json')) {
                    RED.notify('Please select a JSON file', 'error');
                    return;
                }

                var reader = new FileReader();
                reader.onload = function(e) {
                    var jsonText = e.target.result;
                    var data;
                    try {
                        data = JSON.parse(jsonText);
                    } catch (err) {
                        RED.notify('Invalid JSON: ' + err.message, 'error');
                        return;
                    }

                    if (!data.user_id || !data.refresh_token) {
                        RED.notify('JSON must contain user_id and refresh_token', 'error');
                        return;
                    }

                    $('#import-file-status').html('<i class="fa fa-spinner fa-spin"></i> Importing...').show();

                    $.ajax({
                        url: 'philips-airplus/import-credentials',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ node: node.id, credentials: data }),
                        success: function(result) {
                            if (result.success) {
                                RED.notify('Credentials imported successfully!', 'success');
                                node.credentials = node.credentials || {};
                                node.credentials.userId = result.userId;
                                node.credentials.refreshToken = '***loaded***'; // Placeholder (real token stored server-side)
                                node.credentials.expiresAt = String(result.expiresAt);
                                updateAuthStatus();
                                $('#import-json-section').hide();
                                $('#import-file-status').hide();
                            }
                        },
                        error: function(xhr) {
                            var error = xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error';
                            RED.notify('Import failed: ' + error, 'error');
                            $('#import-file-status').hide();
                        }
                    });
                };
                reader.onerror = function() {
                    RED.notify('Failed to read file', 'error');
                };
                reader.readAsText(file);
            }

            // File input change handler
            $('#import-file-input').on('change', function(e) {
                var file = e.target.files[0];
                if (file) {
                    importCredentialsFile(file);
                }
                // Reset input so same file can be selected again
                $(this).val('');
            });

            // Browse button triggers file input
            $('#import-browse-btn').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $('#import-file-input').click();
            });

            // Drag and drop handlers
            var dropZone = $('#import-drop-zone');

            dropZone.on('click', function() {
                $('#import-file-input').click();
            });

            dropZone.on('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).css({
                    'border-color': '#0070d2',
                    'background': '#e8f4ff'
                });
            });

            dropZone.on('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).css({
                    'border-color': '#ccc',
                    'background': '#fafafa'
                });
            });

            dropZone.on('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $(this).css({
                    'border-color': '#ccc',
                    'background': '#fafafa'
                });

                var files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    importCredentialsFile(files[0]);
                }
            });

            // Toggle manual auth section
            $('#show-manual-auth').on('click', function() {
                $('#manual-auth-section').toggle();
            });

            // Manual OAuth flow with popup window
            var authPopup = null;
            var popupPollInterval = null;

            function stopPopupPolling() {
                if (popupPollInterval) {
                    clearInterval(popupPollInterval);
                    popupPollInterval = null;
                }
            }

            function startPopupPolling() {
                stopPopupPolling();
                popupPollInterval = setInterval(function() {
                    if (!authPopup || authPopup.closed) {
                        stopPopupPolling();
                        return;
                    }

                    try {
                        // Try to read popup URL - may work after redirect to custom scheme
                        var url = authPopup.location.href;
                        if (url && url.startsWith('com.philips.air://')) {
                            // Got the redirect URL!
                            stopPopupPolling();
                            authPopup.close();
                            $('#auth-redirect-input').val(url);
                            RED.notify('Captured redirect URL!', 'success');
                            // Auto-submit
                            $('#auth-exchange').click();
                        }
                    } catch (e) {
                        // Cross-origin error - expected while on login page
                    }
                }, 500);
            }

            $('#auth-get-url').on('click', function() {
                $(this).prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> Opening...');

                $.ajax({
                    url: 'philips-airplus/auth/start',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ node: node.id }),
                    success: function(data) {
                        // Open popup window for login
                        authPopup = window.open(
                            data.url,
                            'philips-auth',
                            'width=500,height=700,scrollbars=yes,resizable=yes'
                        );

                        if (!authPopup || authPopup.closed) {
                            // Popup blocked - fallback to showing URL
                            $('#auth-url-display').val(data.url);
                            $('#auth-url-fallback').show();
                            RED.notify('Popup blocked. Copy URL and open in new tab.', 'warning');
                        } else {
                            // Start polling for redirect
                            startPopupPolling();
                            RED.notify('Login window opened. Complete login, then copy redirect URL.', 'info');
                        }

                        $('#auth-step2').show();
                        $('#auth-get-url').prop('disabled', false).html('<i class="fa fa-external-link"></i> 1. Start Login');
                    },
                    error: function(xhr) {
                        var error = xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error';
                        RED.notify('Failed to start auth: ' + error, 'error');
                        $('#auth-get-url').prop('disabled', false).html('<i class="fa fa-external-link"></i> 1. Start Login');
                    }
                });
            });

            $('#auth-url-copy').on('click', function() {
                var url = $('#auth-url-display').val();
                navigator.clipboard.writeText(url).then(function() {
                    RED.notify('URL copied to clipboard', 'success');
                });
            });

            $('#auth-exchange').on('click', function() {
                var redirectUrl = $('#auth-redirect-input').val().trim();
                if (!redirectUrl) {
                    RED.notify('Please paste the redirect URL', 'error');
                    return;
                }

                $(this).prop('disabled', true).text('Exchanging...');

                $.ajax({
                    url: 'philips-airplus/auth/complete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        node: node.id,
                        redirect_url: redirectUrl
                    }),
                    success: function(data) {
                        if (data.success) {
                            RED.notify('Authentication successful!', 'success');
                            node.credentials = node.credentials || {};
                            node.credentials.userId = data.userId;
                            node.credentials.refreshToken = '***loaded***'; // Placeholder (real token stored server-side)
                            node.credentials.expiresAt = String(data.expiresAt);
                            updateAuthStatus();
                            $('#auth-url-display').hide();
                            $('#auth-url-copy').hide();
                            $('#auth-step2').hide();
                            $('#auth-redirect-input').val('');
                            $('#manual-auth-section').hide();
                        } else {
                            RED.notify('Authentication failed: ' + (data.error || 'Unknown'), 'error');
                        }
                        $('#auth-exchange').prop('disabled', false).text('3. Exchange Code');
                    },
                    error: function(xhr) {
                        var error = xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error';
                        RED.notify('Authentication failed: ' + error, 'error');
                        $('#auth-exchange').prop('disabled', false).text('3. Exchange Code');
                    }
                });
            });

            // Re-authenticate button
            $('#auth-reauth').on('click', function() {
                showSetupSection();
            });

            // Export for transfer - with file download
            var exportedCredentials = null;

            function downloadCredentials() {
                if (!exportedCredentials) return;
                var json = JSON.stringify(exportedCredentials, null, 2);
                var blob = new Blob([json], { type: 'application/json' });
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = 'philips-airplus-credentials.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            $('#auth-export').on('click', function() {
                $.ajax({
                    url: 'philips-airplus/export-credentials',
                    type: 'GET',
                    success: function(data) {
                        if (data.credentials) {
                            exportedCredentials = data.credentials;
                            downloadCredentials();
                            $('#export-status').html('Credentials exported. Import on target Node-RED, then clear here.');
                            $('#export-section').show();
                        } else {
                            RED.notify('No credentials to export', 'error');
                        }
                    },
                    error: function(xhr) {
                        var error = xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error';
                        RED.notify('Export failed: ' + error, 'error');
                    }
                });
            });

            $('#export-download-btn').on('click', function() {
                if (exportedCredentials) {
                    downloadCredentials();
                } else {
                    RED.notify('No credentials cached. Click Export again.', 'warning');
                }
            });

            $('#export-clear-btn').on('click', function() {
                if (!confirm('Clear local credentials? Make sure you imported on target first!')) {
                    return;
                }
                $.ajax({
                    url: 'philips-airplus/clear-credentials',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ node: node.id }),
                    success: function(data) {
                        RED.notify('Credentials cleared', 'success');
                        exportedCredentials = null;
                        node.credentials = {};
                        updateAuthStatus();
                        $('#export-section').hide();
                    },
                    error: function(xhr) {
                        var error = xhr.responseJSON ? xhr.responseJSON.error : 'Unknown error';
                        RED.notify('Clear failed: ' + error, 'error');
                    }
                });
            });

            $('#export-close-btn').on('click', function() {
                exportedCredentials = null;
                $('#export-section').hide();
            });

            updateAuthStatus();

            // Fetch and display version info
            $.ajax({
                url: 'philips-airplus/version',
                type: 'GET',
                success: function(data) {
                    var versionText = 'v' + data.package;
                    if (data.git) {
                        versionText += ' (git: ' + data.git + ')';
                    }
                    $('#version-info').text(versionText);
                },
                error: function() {
                    $('#version-info').text('version unknown');
                }
            });
        }
    });
</script>

<script type="text/html" data-template-name="airplus-account">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Philips Air+">
    </div>

    <div class="form-row">
        <label for="node-config-input-verboseLogging"><i class="fa fa-bug"></i> Verbose Logging</label>
        <input type="checkbox" id="node-config-input-verboseLogging" style="width: auto; margin-left: 0px;">
        <span style="margin-left: 10px; font-size: 12px; color: #666;">Log shadow payloads for debugging</span>
    </div>

    <div class="form-row">
        <label><i class="fa fa-key"></i> Authentication</label>
        <div id="auth-status" style="margin-left: 100px; margin-top: -5px; font-weight: bold;"></div>
    </div>

    <div id="auth-section-authenticated" style="display: none; margin-left: 100px; margin-bottom: 20px;">
        <button type="button" id="auth-reauth" class="red-ui-button">Re-authenticate</button>
        <button type="button" id="auth-export" class="red-ui-button" style="margin-left: 10px;">
            <i class="fa fa-download"></i> Export for Transfer
        </button>
    </div>

    <div id="export-section" style="display: none; margin-left: 100px; margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
        <p id="export-status" style="font-size: 12px; color: #666; margin-bottom: 10px;"></p>
        <div style="margin-top: 10px;">
            <button type="button" id="export-download-btn" class="red-ui-button red-ui-button-primary">
                <i class="fa fa-download"></i> Download Again
            </button>
            <button type="button" id="export-clear-btn" class="red-ui-button" style="margin-left: 10px; background: #e74c3c; color: white;">
                <i class="fa fa-trash"></i> Clear Local Credentials
            </button>
            <button type="button" id="export-close-btn" class="red-ui-button" style="margin-left: 10px;">
                Close
            </button>
        </div>
    </div>

    <div id="auth-section-setup" style="margin-left: 100px;">
        <!-- CLI-based auth (recommended) -->
        <div class="form-row" style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
            <strong>CLI Authentication (Recommended)</strong>
            <div id="cli-status" style="margin: 10px 0;"></div>
            <button type="button" id="load-cli-btn" class="red-ui-button" style="display: none;">
                Load from CLI
            </button>
            <button type="button" id="refresh-cli-btn" class="red-ui-button red-ui-button-small" style="margin-left: 5px;">
                <i class="fa fa-refresh"></i> Refresh
            </button>
            <div id="cli-instructions" style="margin-top: 10px; display: none;">
                <p style="font-size: 12px; margin: 5px 0;">
                    Run this command on the Node-RED server:
                </p>
                <code style="display: block; padding: 8px; background: #333; color: #0f0; border-radius: 3px; font-size: 11px;">
                    cd ~/.node-red/node_modules/node-red-contrib-philips-airplus && npm run auth
                </code>
                <p style="font-size: 11px; color: #666; margin-top: 5px;">
                    This opens a browser to log in. Credentials are saved automatically.
                </p>
            </div>
        </div>

        <!-- Import JSON credentials -->
        <div class="form-row" style="margin-top: 10px;">
            <a href="#" id="show-import-json" style="font-size: 12px; color: #666;">
                <i class="fa fa-upload"></i> Import credentials JSON
            </a>
        </div>

        <div id="import-json-section" style="display: none; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                Import JSON from <code>philips-airplus-auth --export</code>:
            </p>
            <input type="file" id="import-file-input" accept=".json,application/json" style="display: none;">
            <div id="import-drop-zone" style="
                border: 2px dashed #ccc;
                border-radius: 4px;
                padding: 30px;
                text-align: center;
                cursor: pointer;
                background: #fafafa;
                transition: all 0.2s ease;
            ">
                <i class="fa fa-upload" style="font-size: 32px; color: #999; margin-bottom: 10px;"></i>
                <p style="margin: 10px 0; color: #666; font-size: 13px;">
                    Drag JSON file here or click to browse
                </p>
                <button type="button" id="import-browse-btn" class="red-ui-button">
                    <i class="fa fa-folder-open"></i> Browse Files
                </button>
            </div>
            <div id="import-file-status" style="margin-top: 10px; font-size: 12px; display: none;"></div>
        </div>

        <!-- Manual auth (fallback) -->
        <div class="form-row" style="margin-top: 10px;">
            <a href="#" id="show-manual-auth" style="font-size: 12px; color: #666;">
                <i class="fa fa-key"></i> Manual authentication (advanced)
            </a>
        </div>

        <div id="manual-auth-section" style="display: none; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            <div class="form-row" style="margin-bottom: 10px;">
                <button type="button" id="auth-get-url" class="red-ui-button red-ui-button-primary">
                    <i class="fa fa-external-link"></i> 1. Start Login
                </button>
            </div>

            <div class="form-row" style="margin-bottom: 10px; display: none;" id="auth-url-fallback">
                <input type="text" id="auth-url-display" readonly style="width: 100%;"
                       placeholder="Authorization URL">
                <button type="button" id="auth-url-copy" class="red-ui-button red-ui-button-small" style="margin-top: 5px;">
                    <i class="fa fa-copy"></i> Copy URL
                </button>
            </div>

            <div id="auth-step2" style="display: none;">
                <div class="form-row" style="background: #fff3cd; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                    <p style="font-size: 12px; color: #856404; margin: 0;">
                        <strong>2. After logging in:</strong> The browser will show an error page
                        (cannot open <code>com.philips.air://</code>). Copy the <strong>entire URL</strong>
                        from the address bar and paste it below.
                    </p>
                </div>

                <div class="form-row" style="margin-bottom: 10px;">
                    <input type="text" id="auth-redirect-input" style="width: 100%;"
                           placeholder="Paste URL from address bar (com.philips.air://loginredirect?code=...)">
                </div>

                <div class="form-row">
                    <button type="button" id="auth-exchange" class="red-ui-button red-ui-button-primary">
                        <i class="fa fa-check"></i> 3. Complete Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div style="margin-top: 20px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 11px; color: #999; text-align: right;">
        <span id="version-info">Loading version...</span>
    </div>

    <style>
        .auth-success { color: #2ecc71; }
        .auth-error { color: #e74c3c; }
        #import-drop-zone:hover {
            border-color: #0070d2;
            background: #f0f8ff;
        }
    </style>
</script>

<script type="text/html" data-help-name="airplus-account">
    <p>Configuration node for Philips Air+ cloud account.</p>

    <h3>Authentication</h3>
    <p>Two authentication methods are available:</p>

    <h4>CLI Authentication (Recommended)</h4>
    <p>Run this command on the Node-RED server:</p>
    <pre>cd ~/.node-red/node_modules/node-red-contrib-philips-airplus && npm run auth</pre>
    <p>This opens a browser window for login. After successful authentication,
    click "Load from CLI" in the node configuration to import the credentials.</p>

    <h4>Manual Authentication</h4>
    <p>If CLI is not available (e.g., headless server), use manual OAuth:</p>
    <ol>
        <li>Click "Get Auth URL" to generate an authorization URL</li>
        <li>Open the URL in your browser and log in to your Philips account</li>
        <li>After login, you'll be redirected to a URL starting with <code>com.philips.air://</code></li>
        <li>Copy that entire redirect URL and paste it in the input field</li>
        <li>Click "Exchange Code" to complete authentication</li>
    </ol>

    <h3>Connection</h3>
    <p>Once authenticated, the node maintains a WebSocket connection to receive
    real-time device updates via MQTT.</p>

    <h3>Token Refresh</h3>
    <p>Tokens are automatically refreshed before expiration. If refresh fails,
    you'll need to re-authenticate.</p>
</script>
